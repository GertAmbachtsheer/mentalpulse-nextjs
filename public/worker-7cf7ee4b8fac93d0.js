(()=>{"use strict";let e=self;e.addEventListener("push",t=>{let n=t.data?.json()??{},i=n.title||"MentalPulse Alert",o={body:n.body||"You have a new notification",icon:n.icon||"/icon512_rounded.png",badge:n.badge||"/icon512_rounded.png",data:n.data||{},requireInteraction:n.requireInteraction??!0,actions:[]};n.data?.type==="panic-alert"?o.actions=[{action:"respond",title:"\uD83D\uDC9A Respond"},{action:"decline",title:"Dismiss"}]:n.data?.type==="panic-response"?o.actions=[{action:"view-response",title:"\uD83D\uDDFAï¸ View Map"},{action:"close",title:"Dismiss"}]:n.data?.type==="alert-cancelled"?o.actions=[{action:"close",title:"OK"}]:o.actions=[{action:"view",title:"View Details"},{action:"close",title:"Dismiss"}],t.waitUntil(e.registration.showNotification(i,o))}),e.addEventListener("notificationclick",t=>{console.log("[SW] Notification clicked:",t.action,t.notification.data),t.notification.close();let n=t.action,i=t.notification.data;if("respond"===n&&i?.type==="panic-alert")t.waitUntil((async()=>{try{for(let t of(await e.clients.matchAll({type:"window",includeUncontrolled:!0})))if(t.url.includes(e.location.origin)&&"focus"in t)return t.postMessage({type:"NOTIFICATION_CLICK",action:"respond",alertId:i.alertId,triggerUserId:i.triggerUserId}),t.focus();if(e.clients.openWindow)return e.clients.openWindow(`/?respondToAlert=${i.alertId}`)}catch(e){console.error("[SW] Error handling respond action:",e)}})());else if("view-response"===n&&i?.type==="panic-response")t.waitUntil((async()=>{try{for(let t of(await e.clients.matchAll({type:"window",includeUncontrolled:!0})))if(t.url.includes(e.location.origin)&&"focus"in t)return t.postMessage({type:"SHOW_RESPONSE_MAP",alertId:i.alertId,responderUserId:i.responderUserId,responderLatitude:i.responderLatitude,responderLongitude:i.responderLongitude,alertLatitude:i.alertLatitude,alertLongitude:i.alertLongitude}),t.focus();if(e.clients.openWindow)return e.clients.openWindow("/")}catch(e){console.error("[SW] Error handling view-response action:",e)}})());else if("close"!==n&&n||i?.type!=="alert-cancelled")if("decline"===n||"close"===n)return;else i?.type==="panic-response"?t.waitUntil((async()=>{try{for(let t of(await e.clients.matchAll({type:"window",includeUncontrolled:!0})))if(t.url.includes(e.location.origin)&&"focus"in t)return t.postMessage({type:"SHOW_RESPONSE_MAP",alertId:i.alertId,responderUserId:i.responderUserId,responderLatitude:i.responderLatitude,responderLongitude:i.responderLongitude,alertLatitude:i.alertLatitude,alertLongitude:i.alertLongitude}),t.focus();if(e.clients.openWindow)return e.clients.openWindow("/")}catch(e){console.error("[SW] Error handling panic-response click:",e)}})()):t.waitUntil(e.clients.matchAll({type:"window",includeUncontrolled:!0}).then(t=>{for(let n of t)if(n.url.includes(e.location.origin)&&"focus"in n)return n.focus();if(e.clients.openWindow)return e.clients.openWindow("/")}));else t.waitUntil((async()=>{try{for(let t of(await e.clients.matchAll({type:"window",includeUncontrolled:!0})))if(t.url.includes(e.location.origin)&&"focus"in t)return t.postMessage({type:"ALERT_CANCELLED",alertId:i.alertId}),t.focus();if(e.clients.openWindow)return e.clients.openWindow("/")}catch(e){console.error("[SW] Error handling alert-cancelled action:",e)}})())})})();